<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas - Planilha de Organização Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #FFF2EB; 
            color: #5D4037; 
        }
        .table-cell, .table-cell-contenteditable {
            padding: 0.75rem;
            border: 1px solid #FFE8CD; 
            vertical-align: middle;
        }
        .table-cell-status {
            padding: 0.5rem; 
            border: 1px solid #FFE8CD;
            text-align: center;
            cursor: pointer;
            width: 60px; 
        }
        .table-cell-contenteditable:focus {
            outline: 2px solid #FFD6BA; 
            border-color: transparent;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .status-select, .compromisso-select {
            min-width: 120px;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #FFE8CD;
            background-color: white;
            font-size: 0.875rem;
            color: #5D4037;
        }
        .custom-button {
            background-color: #FFD6BA;
            color: #5D4037;
            font-weight: 600;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            border: 1px solid #FFE8CD;
        }
        .custom-button:hover {
            background-color: #FFE8CD;
        }

        .main-action-icon-button {
            background-color: #FFD6BA; 
            color: #FF9898; 
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border: 1px solid #FFE8CD;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
        }
        .main-action-icon-button:hover {
            background-color: #FFE8CD; 
            color: #E67A7A; 
        }
        .main-action-icon-button svg {
            width: 1.5rem; 
            height: 1.5rem; 
        }

        .table-action-icon-button {
            background-color: transparent;
            padding: 0.3rem;
            border-radius: 0.375rem;
            transition: color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .table-action-icon-button svg {
            width: 1.25rem; 
            height: 1.25rem; 
        }
        .details-icon { color: #FFB7A5; } 
        .details-icon:hover { color: #E6A47C; }
        .remove-icon { color: #FF9898; } 
        .remove-icon:hover { color: #E67A7A; }
        
        svg.status-icon { 
            width: 0.875rem;
            height: 0.875rem;
            margin: auto; 
        }


        .main-container {
            background-color: #FFDCDC;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .table-container {
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #FFE8CD;
        }
        thead {
            background-color: #FFE8CD;
        }
        th {
            color: #5D4037;
            font-weight: 600;
            padding: 0.75rem;
        }
        .modal-content {
            background-color: #FFF2EB;
            border-radius: 0.75rem;
            border: 1px solid #FFE8CD;
        }
        input[type="text"], input[type="date"], textarea, select {
            border-radius: 0.5rem !important;
            border: 1px solid #FFE8CD !important;
            padding: 0.5rem 0.75rem !important;
            color: #5D4037;
        }
        input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            border-color: #FFD6BA !important;
            box-shadow: 0 0 0 2px rgba(255, 214, 186, 0.5) !important;
        }

        @media print {
            body { background-color: white !important; color: black !important; font-family: 'Quicksand', sans-serif !important; }
            body * { visibility: hidden; background-color: white !important; color: black !important; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            table { border-collapse: collapse !important; width: 100% !important; }
            th, td { border: 1px solid #ccc !important; padding: 6px !important; font-size: 10pt !important; }
            svg.status-icon { width: 0.75rem !important; height: 0.75rem !important;} 
            .main-container, .modal-content { box-shadow: none !important; border: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-5xl main-container">
        <header class="mb-6 text-center">
            <h1 class="text-4xl font-bold" style="color: #B06A50;">Tarefas</h1>
        </header>

        <div class="flex justify-center no-print mb-6">
            <div class="inline-block"> 
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label for="compromissoInput" class="block text-sm font-medium mb-1">Compromisso:</label>
                        <select id="compromissoInput" class="compromisso-select w-full md:w-auto shadow-sm">
                            </select>
                    </div>
                    <div>
                        <label for="tarefaInput" class="block text-sm font-medium mb-1">Nova Tarefa:</label>
                        <input type="text" id="tarefaInput" placeholder="Descrição da tarefa" class="w-full md:w-auto shadow-sm">
                    </div>
                    <div>
                        <label for="dataInput" class="block text-sm font-medium mb-1">Data Limite:</label>
                        <input type="date" id="dataInput" class="w-full md:w-auto shadow-sm">
                    </div>
                    <button onclick="adicionarTarefa()" title="Adicionar Tarefa" class="main-action-icon-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                    </button>
                    <button onclick="imprimirPlanilha()" title="Imprimir Planilha" class="main-action-icon-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                    </button>
                    <button id="toggleGerenciarBtn" title="Gerenciar Compromissos" class="main-action-icon-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.39 1.024 0 1.414l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.39.39.39 1.024 0 1.414l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.78.93l-.15.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.149-.894c-.07-.424-.384-.764-.78-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.389.39-1.024.39-1.414 0l-.774-.773a1.125 1.125 0 0 1-.12-1.45l.528-.737c.25-.35.272-.806.107-1.204-.165-.397-.506-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.528-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71.505.78-.93l.15-.894Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </button>
                </div>
                
                <div id="gerenciarCompromissosSection" class="w-full mt-4 p-4 border rounded-lg bg-white/50 no-print hidden" style="border-color: #FFE8CD; background-color: rgba(255, 242, 235, 0.7);">
                    <h2 class="text-xl font-semibold mb-3" style="color: #B06A50;">Gerenciar Compromissos</h2>
                    <div class="flex flex-wrap gap-3 items-end mb-4"> 
                         <div>
                            <label for="renomearCompromissoInput" class="block text-sm font-medium mb-1">Novo nome para selecionado:</label>
                            <input type="text" id="renomearCompromissoInput" placeholder="Novo nome" class="w-full md:w-auto shadow-sm">
                        </div>
                        <button onclick="renomearCompromissoSelecionado()" class="custom-button">Renomear Selecionado</button>
                        <button onclick="removerCompromissoSelecionado()" class="custom-button !bg-red-300 hover:!bg-red-400 !text-white">Remover Selecionado</button>
                    </div>
                     <p class="text-xs mt-1 mb-3 italic" style="color: #B06A50;">Para renomear ou remover, selecione um compromisso na lista acima ("Compromisso" para adicionar tarefa).</p>
                    <div class="flex flex-wrap gap-3 items-end border-t pt-4" style="border-color: #FFE8CD;"> 
                        <div>
                            <label for="novoCompromissoInput" class="block text-sm font-medium mb-1">Novo Compromisso:</label>
                            <input type="text" id="novoCompromissoInput" placeholder="Nome do novo compromisso" class="w-full md:w-auto shadow-sm">
                        </div>
                        <button onclick="adicionarNovoCompromisso()" class="custom-button">Adicionar Novo</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="overflow-x-auto printable-area table-container">
            <table id="tabelaTarefas" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="text-left p-3 border-b">Compromisso</th>
                        <th class="text-left p-3 border-b">Tarefa</th>
                        <th class="text-left p-3 border-b">Data Limite</th>
                        <th class="text-center p-3 border-b">Status</th> 
                        <th class="text-left p-3 border-b no-print">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="messageBox" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg hidden no-print z-50" style="background-color: #B06A50; color: #FFF2EB;">
            <p id="messageText"></p>
        </div>
    </div>

    <div id="taskDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-40 overflow-y-auto h-full w-full flex items-center justify-center hidden no-print z-40">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-lg modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" style="color: #B06A50;">Detalhes da Tarefa</h3>
                <button onclick="fecharModalDetalhes()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
            </div>
            <div class="space-y-4 text-sm">
                <div>
                    <label for="modalCompromisso" class="block font-medium">Compromisso:</label>
                    <select id="modalCompromisso" class="compromisso-select mt-1 block w-full shadow-sm bg-gray-50">
                    </select>
                </div>
                <div>
                    <label for="modalTarefa" class="block font-medium">Tarefa:</label>
                    <input type="text" id="modalTarefa" class="mt-1 block w-full shadow-sm">
                </div>
                <div>
                    <label for="modalDataLimite" class="block font-medium">Data Limite:</label>
                    <input type="date" id="modalDataLimite" class="mt-1 block w-full shadow-sm">
                </div>
                <div>
                    <label for="modalStatus" class="block font-medium">Status:</label>
                    <select id="modalStatus" class="status-select mt-1 block w-full shadow-sm">
                        <option value="A Fazer">A Fazer</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Feito">Feito</option>
                    </select>
                </div>
                <div>
                    <label for="modalDescricao" class="block font-medium">Descrição Detalhada:</label>
                    <textarea id="modalDescricao" rows="3" class="mt-1 block w-full shadow-sm"></textarea>
                </div>
                <div>
                    <label for="modalLocal" class="block font-medium">Local:</label>
                    <input type="text" id="modalLocal" class="mt-1 block w-full shadow-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="fecharModalDetalhes()" class="custom-button !bg-gray-200 !text-gray-700 hover:!bg-gray-300">Cancelar</button>
                <button type="button" onclick="salvarDetalhesTarefa()" class="custom-button">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa as funções necessárias dos SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        // Removido getAnalytics se não estiver sendo usado diretamente para economizar no bundle.
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        // Adicione outros SDKs do Firebase que você queira usar aqui
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Sua configuração do Firebase (fornecida por você)
        const firebaseConfig = {
            apiKey: "AIzaSyB0to2uW48E0VsScAPAWmoK5KoH-ZbzlPY",
            authDomain: "minhas-tarefas-app-inara.firebaseapp.com",
            projectId: "minhas-tarefas-app-inara",
            storageBucket: "minhas-tarefas-app-inara.firebasestorage.app",
            messagingSenderId: "1092443122843",
            appId: "1:1092443122843:web:9346cf62cd3a90d46a2a3e",
            measurementId: "G-4D6012QFKB" // Opcional, mas bom manter se o Analytics estiver habilitado no projeto Firebase
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app); // Descomente se for usar o Analytics ativamente
        const db = getFirestore(app);

        // Expõe o 'db' e as funções do Firestore para o script principal
        window.db = db; 
        window.firestoreFunctions = { 
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc, 
            query, where, onSnapshot, serverTimestamp, orderBy, writeBatch 
        };
    </script>

    <script>
        // Seu JavaScript principal da planilha (existente)
        let linhaEditadaPeloModal = null;
        let compromissos = []; // Será populado pelo Firebase
        let tarefasListenerUnsubscribe = null; // Para cancelar o listener do onSnapshot
        let compromissosListenerUnsubscribe = null;


        const statusMap = {
            "A Fazer": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="status-icon text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                next: "Em Andamento",
            },
            "Em Andamento": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="status-icon text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>`,
                next: "Feito",
            },
            "Feito": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="status-icon text-green-500"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`,
                next: "A Fazer",
            }
        };

        function showMessage(text, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), duration);
        }

        function formatarDataParaInput(dataDisplay) {
            if (!dataDisplay || !dataDisplay.includes('/')) return "";
            const partes = dataDisplay.split('/');
            return partes.length === 3 ? `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}` : "";
        }

        function formatarDataParaDisplay(dataInput) { // YYYY-MM-DD ou Timestamp do Firebase
            if (!dataInput) return "";
            if (typeof dataInput === 'object' && dataInput.seconds) { // É um Timestamp do Firebase
                const date = new Date(dataInput.seconds * 1000);
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0'); // Meses são 0-indexed
                const ano = date.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } else if (typeof dataInput === 'string' && dataInput.includes('-')) { // É YYYY-MM-DD
                const partes = dataInput.split('-');
                return partes.length === 3 ? `${partes[2].padStart(2, '0')}/${partes[1].padStart(2, '0')}/${partes[0]}` : "";
            }
            return dataInput; // Retorna como está se não for nenhum dos formatos esperados
        }


        function popularSelectsCompromisso(listaCompromissos = compromissos) {
            const selects = [document.getElementById('compromissoInput'), document.getElementById('modalCompromisso')];
            selects.forEach(select => {
                if (!select) return;
                const valorSelecionadoAnteriormente = select.value;
                select.innerHTML = ""; // Limpa opções existentes
                listaCompromissos.forEach(comp => {
                    const option = document.createElement('option');
                    option.value = comp.nome; // Assume que o objeto comp tem um campo 'nome'
                    option.textContent = comp.nome;
                    if (comp.id) { // Armazena o ID do Firebase se disponível
                        option.dataset.id = comp.id;
                    }
                    select.appendChild(option);
                });
                if (listaCompromissos.some(c => c.nome === valorSelecionadoAnteriormente)) {
                    select.value = valorSelecionadoAnteriormente;
                } else if (listaCompromissos.length > 0) {
                    select.value = listaCompromissos[0].nome;
                }
            });
        }

        async function adicionarNovoCompromisso() {
            const { db, firestoreFunctions } = window;
            const { collection, addDoc, serverTimestamp } = firestoreFunctions;
            const input = document.getElementById('novoCompromissoInput');
            const nomeCompromisso = input.value.trim();

            if (nomeCompromisso === "") {
                showMessage("Por favor, insira um nome para o novo compromisso.");
                return;
            }
            if (compromissos.some(c => c.nome === nomeCompromisso)) {
                showMessage("Este compromisso já existe.");
                return;
            }
            try {
                await addDoc(collection(db, "compromissos"), { 
                    nome: nomeCompromisso,
                    criadoEm: serverTimestamp() 
                });
                input.value = "";
                showMessage(`Compromisso "${nomeCompromisso}" adicionado.`);
                // O listener onSnapshot cuidará de atualizar a UI
            } catch (error) {
                console.error("Erro ao adicionar compromisso: ", error);
                showMessage("Erro ao adicionar compromisso.");
            }
        }

        async function renomearCompromissoSelecionado() {
            const { db, firestoreFunctions } = window;
            const { doc, updateDoc, collection, query, where, getDocs, writeBatch } = firestoreFunctions;

            const selectCompromissoPrincipal = document.getElementById('compromissoInput');
            const optionSelecionada = selectCompromissoPrincipal.options[selectCompromissoPrincipal.selectedIndex];
            const nomeAntigo = optionSelecionada.value;
            const compromissoId = optionSelecionada.dataset.id;


            if (!compromissoId) {
                showMessage("Nenhum compromisso selecionado ou ID não encontrado para renomear.");
                return;
            }
            const inputNovoNome = document.getElementById('renomearCompromissoInput');
            const nomeNovo = inputNovoNome.value.trim();

            if (nomeNovo === "") {
                showMessage("Por favor, insira o novo nome para o compromisso.");
                return;
            }
            if (nomeNovo === nomeAntigo) {
                showMessage("O novo nome é igual ao antigo.");
                return;
            }
            if (compromissos.some(c => c.nome === nomeNovo && c.id !== compromissoId)) {
                showMessage(`O compromisso "${nomeNovo}" já existe.`);
                return;
            }

            try {
                const compromissoRef = doc(db, "compromissos", compromissoId);
                await updateDoc(compromissoRef, { nome: nomeNovo });

                // Atualizar o nome do compromisso em todas as tarefas associadas
                const tarefasQuery = query(collection(db, "tarefas"), where("compromissoNome", "==", nomeAntigo));
                const tarefasSnapshot = await getDocs(tarefasQuery);
                
                const batch = writeBatch(db);
                tarefasSnapshot.forEach((tarefaDoc) => {
                    const tarefaRef = doc(db, "tarefas", tarefaDoc.id);
                    batch.update(tarefaRef, { compromissoNome: nomeNovo });
                });
                await batch.commit();

                showMessage(`Compromisso "${nomeAntigo}" renomeado para "${nomeNovo}".`);
                inputNovoNome.value = "";
                // O listener onSnapshot atualizará a UI, incluindo o select
            } catch (error) {
                console.error("Erro ao renomear compromisso: ", error);
                showMessage("Erro ao renomear compromisso.");
            }
        }

        async function removerCompromissoSelecionado() {
            const { db, firestoreFunctions } = window;
            const { doc, deleteDoc, collection, query, where, getDocs, writeBatch } = firestoreFunctions;

            const selectCompromissoPrincipal = document.getElementById('compromissoInput');
            const optionSelecionada = selectCompromissoPrincipal.options[selectCompromissoPrincipal.selectedIndex];
            const nomeCompromissoParaRemover = optionSelecionada.value;
            const compromissoIdParaRemover = optionSelecionada.dataset.id;
            
            if (!compromissoIdParaRemover) {
                showMessage("Nenhum compromisso selecionado ou ID não encontrado para remover.");
                return;
            }
            if (confirm(`Tem certeza que deseja remover o compromisso "${nomeCompromissoParaRemover}"? TODAS AS TAREFAS associadas a este compromisso também serão removidas.`)) {
                try {
                    // Iniciar um batch para deletar o compromisso e suas tarefas
                    const batch = writeBatch(db);

                    // Deletar o compromisso
                    const compromissoRef = doc(db, "compromissos", compromissoIdParaRemover);
                    batch.delete(compromissoRef);

                    // Encontrar e deletar todas as tarefas associadas
                    const tarefasQuery = query(collection(db, "tarefas"), where("compromissoNome", "==", nomeCompromissoParaRemover));
                    const tarefasSnapshot = await getDocs(tarefasQuery);
                    tarefasSnapshot.forEach((tarefaDoc) => {
                        batch.delete(doc(db, "tarefas", tarefaDoc.id));
                    });
                    
                    await batch.commit();
                    showMessage(`Compromisso "${nomeCompromissoParaRemover}" e suas tarefas foram removidos.`);
                    // O listener onSnapshot cuidará de atualizar a UI.
                } catch (error) {
                    console.error("Erro ao remover compromisso e tarefas: ", error);
                    showMessage("Erro ao remover compromisso.");
                }
            }
        }
        
        async function cycleStatus(linha, tarefaId) {
            const { db, firestoreFunctions } = window;
            const { doc, updateDoc } = firestoreFunctions;

            let currentStatus = linha.dataset.status || "A Fazer";
            let nextStatus = statusMap[currentStatus].next;
            
            try {
                const tarefaRef = doc(db, "tarefas", tarefaId);
                await updateDoc(tarefaRef, { status: nextStatus });
                // A UI será atualizada pelo listener onSnapshot
                showMessage("Status atualizado!");
            } catch (error) {
                console.error("Erro ao atualizar status: ", error);
                showMessage("Erro ao atualizar status.");
            }
        }

        async function adicionarTarefa() {
            const { db, firestoreFunctions } = window;
            const { collection, addDoc, serverTimestamp } = firestoreFunctions;

            const compromissoNome = document.getElementById('compromissoInput').value;
            const tarefaDescricao = document.getElementById('tarefaInput').value;
            let dataLimiteInput = document.getElementById('dataInput').value; // YYYY-MM-DD

            if (tarefaDescricao.trim() === "") {
                showMessage("Por favor, insira a descrição da tarefa.");
                return;
            }
            if (!compromissoNome) {
                 showMessage("Por favor, selecione um compromisso.");
                return;
            }

            // Converte a data para Timestamp do Firebase se houver valor, senão null
            let dataLimiteTimestamp = null;
            if (dataLimiteInput) {
                const [year, month, day] = dataLimiteInput.split('-');
                dataLimiteTimestamp = new Date(year, month - 1, day); // Mês é 0-indexed
            }

            try {
                await addDoc(collection(db, "tarefas"), {
                    compromissoNome: compromissoNome,
                    descricao: tarefaDescricao,
                    dataLimite: dataLimiteTimestamp, // Salva como Timestamp ou null
                    status: "A Fazer",
                    detalhes: "",
                    local: "",
                    criadoEm: serverTimestamp()
                });
                document.getElementById('tarefaInput').value = "";
                document.getElementById('dataInput').value = "";
                showMessage("Tarefa adicionada com sucesso!");
                // O listener onSnapshot cuidará de atualizar a UI
            } catch (error) {
                console.error("Erro ao adicionar tarefa: ", error);
                showMessage("Erro ao adicionar tarefa.");
            }
        }
        
        async function removerTarefa(tarefaId) {
            const { db, firestoreFunctions } = window;
            const { doc, deleteDoc } = firestoreFunctions;
            if (confirm("Tem certeza que deseja remover esta tarefa?")) {
                try {
                    await deleteDoc(doc(db, "tarefas", tarefaId));
                    showMessage("Tarefa removida.");
                    // O listener onSnapshot cuidará de atualizar a UI
                } catch (error) {
                    console.error("Erro ao remover tarefa: ", error);
                    showMessage("Erro ao remover tarefa.");
                }
            }
        }

        function abrirModalDetalhes(linha, tarefa) { // tarefa é o objeto de dados do Firestore
            linhaEditadaPeloModal = linha; // A linha da tabela (elemento TR)
            window.tarefaAtualModalId = tarefa.id; // Armazena o ID da tarefa para salvar

            if (!linhaEditadaPeloModal) return;
            
            popularSelectsCompromisso(compromissos); // Passa a lista atual de compromissos
            document.getElementById('modalCompromisso').value = tarefa.compromissoNome;
            document.getElementById('modalTarefa').value = tarefa.descricao;
            document.getElementById('modalDataLimite').value = tarefa.dataLimite ? formatarDataParaInput(formatarDataParaDisplay(tarefa.dataLimite)) : "";
            document.getElementById('modalStatus').value = tarefa.status || "A Fazer"; 
            document.getElementById('modalDescricao').value = tarefa.detalhes || "";
            document.getElementById('modalLocal').value = tarefa.local || "";

            document.getElementById('taskDetailsModal').classList.remove('hidden');
            document.body.classList.add('modal-active');
        }

        function fecharModalDetalhes() {
            document.getElementById('taskDetailsModal').classList.add('hidden');
            document.body.classList.remove('modal-active');
            linhaEditadaPeloModal = null;
            window.tarefaAtualModalId = null;
        }

        async function salvarDetalhesTarefa() {
            const { db, firestoreFunctions } = window;
            const { doc, updateDoc } = firestoreFunctions;

            if (!window.tarefaAtualModalId) {
                showMessage("Erro: ID da tarefa não encontrado para salvar.");
                return;
            }

            const tarefaId = window.tarefaAtualModalId;
            let dataLimiteModal = document.getElementById('modalDataLimite').value;
            let dataLimiteTimestampModal = null;
            if (dataLimiteModal) {
                const [year, month, day] = dataLimiteModal.split('-');
                dataLimiteTimestampModal = new Date(year, month - 1, day);
            }
            
            const dadosAtualizados = {
                compromissoNome: document.getElementById('modalCompromisso').value,
                descricao: document.getElementById('modalTarefa').value,
                dataLimite: dataLimiteTimestampModal,
                status: document.getElementById('modalStatus').value,
                detalhes: document.getElementById('modalDescricao').value,
                local: document.getElementById('modalLocal').value
            };

            try {
                const tarefaRef = doc(db, "tarefas", tarefaId);
                await updateDoc(tarefaRef, dadosAtualizados);
                showMessage("Detalhes da tarefa salvos!");
                fecharModalDetalhes();
                // O listener onSnapshot cuidará de atualizar a UI
            } catch (error) {
                console.error("Erro ao salvar detalhes da tarefa: ", error);
                showMessage("Erro ao salvar detalhes.");
            }
        }

        function imprimirPlanilha() {
            window.print();
        }

        function renderizarTabelaTarefas(listaTarefas) {
            const tabelaCorpo = document.getElementById('tabelaTarefas').getElementsByTagName('tbody')[0];
            tabelaCorpo.innerHTML = ""; // Limpa a tabela antes de renderizar

            listaTarefas.forEach(tarefa => { // tarefa é o objeto de dados do Firestore com seu ID
                const novaLinha = tabelaCorpo.insertRow();
                novaLinha.dataset.id = tarefa.id; // Armazena o ID do Firestore na linha
                novaLinha.dataset.descricao = tarefa.detalhes || "";
                novaLinha.dataset.local = tarefa.local || "";
                novaLinha.dataset.status = tarefa.status || "A Fazer";

                novaLinha.insertCell().textContent = tarefa.compromissoNome;
                novaLinha.cells[0].classList.add('table-cell', 'p-3', 'border-b');
                
                novaLinha.insertCell().textContent = tarefa.descricao;
                novaLinha.cells[1].classList.add('table-cell-contenteditable', 'p-3', 'border-b');
                // Desabilitar edição direta na tabela por enquanto para simplificar com Firestore
                // novaLinha.cells[1].setAttribute('contenteditable', 'true'); 

                novaLinha.insertCell().textContent = formatarDataParaDisplay(tarefa.dataLimite);
                novaLinha.cells[2].classList.add('table-cell-contenteditable', 'p-3', 'border-b');
                // novaLinha.cells[2].setAttribute('contenteditable', 'true');
                
                const celulaStatus = novaLinha.insertCell();
                celulaStatus.classList.add('table-cell-status', 'p-3', 'border-b');
                celulaStatus.innerHTML = statusMap[tarefa.status].icon;
                celulaStatus.onclick = () => cycleStatus(novaLinha, tarefa.id);
                
                const celulaAcoes = novaLinha.insertCell();
                celulaAcoes.classList.add('p-3', 'border-b', 'no-print', 'space-x-1');
                
                const btnDetalhes = document.createElement('button');
                btnDetalhes.title = "Detalhes";
                btnDetalhes.classList.add('table-action-icon-button', 'details-icon');
                btnDetalhes.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`;
                btnDetalhes.onclick = () => abrirModalDetalhes(novaLinha, tarefa); // Passa o objeto tarefa
                
                const btnRemover = document.createElement('button');
                btnRemover.title = "Remover";
                btnRemover.classList.add('table-action-icon-button', 'remove-icon');
                btnRemover.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c1.153 0 2.24.086 3.305.247m-.01 0c5.114 0 9.756-1.544 13.39-4.257" /></svg>`;
                btnRemover.onclick = () => removerTarefa(tarefa.id);

                celulaAcoes.appendChild(btnDetalhes);
                celulaAcoes.appendChild(btnRemover);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            const { db, firestoreFunctions } = window;
            if (!db || !firestoreFunctions) {
                console.error("Firebase não foi inicializado corretamente.");
                showMessage("Erro ao conectar com o banco de dados. Verifique o console.");
                return;
            }
            const { collection, query, onSnapshot, orderBy } = firestoreFunctions;

            // Listener para Compromissos
            const qCompromissos = query(collection(db, "compromissos"), orderBy("nome", "asc"));
            compromissosListenerUnsubscribe = onSnapshot(qCompromissos, (querySnapshot) => {
                const listaCompromissosFirestore = [];
                querySnapshot.forEach((doc) => {
                    listaCompromissosFirestore.push({ id: doc.id, ...doc.data() });
                });
                compromissos = listaCompromissosFirestore; // Atualiza a variável global
                popularSelectsCompromisso(compromissos); // Passa a lista carregada
            }, (error) => {
                console.error("Erro ao carregar compromissos: ", error);
                showMessage("Erro ao carregar lista de compromissos.");
            });

            // Listener para Tarefas
            const qTarefas = query(collection(db, "tarefas"), orderBy("criadoEm", "desc")); // Ordena por mais recentes
            tarefasListenerUnsubscribe = onSnapshot(qTarefas, (querySnapshot) => {
                const listaTarefasFirestore = [];
                querySnapshot.forEach((doc) => {
                    listaTarefasFirestore.push({ id: doc.id, ...doc.data() });
                });
                renderizarTabelaTarefas(listaTarefasFirestore);
            }, (error) => {
                console.error("Erro ao carregar tarefas: ", error);
                showMessage("Erro ao carregar tarefas.");
            });
            
            const toggleGerenciarBtn = document.getElementById('toggleGerenciarBtn');
            const gerenciarCompromissosSection = document.getElementById('gerenciarCompromissosSection');
            if(toggleGerenciarBtn && gerenciarCompromissosSection) {
                toggleGerenciarBtn.addEventListener('click', function() {
                    const controlsWrapper = document.querySelector('.flex.justify-center.no-print .inline-block');
                    if (controlsWrapper && !controlsWrapper.contains(gerenciarCompromissosSection)) {
                         controlsWrapper.appendChild(gerenciarCompromissosSection);
                    }
                    gerenciarCompromissosSection.classList.toggle('hidden');
                });
            }
        });

        // Limpar listeners quando a página for descarregada (opcional, mas boa prática)
        window.addEventListener('beforeunload', () => {
            if (compromissosListenerUnsubscribe) {
                compromissosListenerUnsubscribe();
            }
            if (tarefasListenerUnsubscribe) {
                tarefasListenerUnsubscribe();
            }
        });

    </script>
</body>
</html>
